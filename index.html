<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Rental Matching Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 800;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            letter-spacing: 1px;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .card h3 {
            color: #2c5364;
            margin-bottom: 15px;
            font-size: 1.5em;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d8db;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2c5364;
            background: white;
            box-shadow: 0 0 10px rgba(44, 83, 100, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(44, 83, 100, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(44, 83, 100, 0.5);
            background: linear-gradient(135deg, #203a43 0%, #0f2027 100%);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .status h4 {
            color: #2c5364;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .matches-section {
            grid-column: 1 / -1;
        }

        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .match-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecef 100%);
            border-radius: 12px;
            padding: 18px;
            border-left: 5px solid #2c5364;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .match-card:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .privacy-notice {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            color: white;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .privacy-notice h4 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.3em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #c92a2a;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            font-weight: 600;
        }

        .success {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #2b8a3e;
            box-shadow: 0 4px 15px rgba(81, 207, 102, 0.3);
            font-weight: 600;
        }

        .connect-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            margin-bottom: 10px;
        }

        .connect-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #0c6674 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-section {
            margin-top: 20px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .user-section h3 {
            font-size: 1.5em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .listings-requests {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .item-list {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 18px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .item-list h4 {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .item {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 0.9em;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .item:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateX(5px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .listings-requests {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Anonymous Rental Matching</h1>
            <p>Privacy-preserving property matching using FHE encryption</p>
        </div>

        <div class="wallet-info" id="walletInfo">
            <button class="btn connect-btn" onclick="connectWallet()">Connect MetaMask Wallet</button>
            <p>Connect your wallet to start using the platform</p>
        </div>

        <div class="main-content">
            <div class="card">
                <h3>üè° Create Property Listing</h3>
                <div class="form-group">
                    <label for="listingPrice">Monthly Rent (USD):</label>
                    <input type="number" id="listingPrice" placeholder="e.g. 1500" min="1">
                </div>
                <div class="form-group">
                    <label for="listingBedrooms">Bedrooms:</label>
                    <select id="listingBedrooms">
                        <option value="1">1 Bedroom</option>
                        <option value="2">2 Bedrooms</option>
                        <option value="3">3 Bedrooms</option>
                        <option value="4">4 Bedrooms</option>
                        <option value="5">5+ Bedrooms</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="listingPostal">Postal Code:</label>
                    <input type="number" id="listingPostal" placeholder="e.g. 10001" min="1">
                </div>
                <div class="form-group">
                    <label for="listingType">Property Type:</label>
                    <select id="listingType">
                        <option value="1">Apartment</option>
                        <option value="2">House</option>
                        <option value="3">Studio</option>
                    </select>
                </div>
                <button class="btn" onclick="createListing()">Create Encrypted Listing</button>
            </div>

            <div class="card">
                <h3>üîç Create Rental Request</h3>
                <div class="form-group">
                    <label for="requestBudget">Max Budget (USD):</label>
                    <input type="number" id="requestBudget" placeholder="e.g. 1800" min="1">
                </div>
                <div class="form-group">
                    <label for="requestBedrooms">Minimum Bedrooms:</label>
                    <select id="requestBedrooms">
                        <option value="1">1 Bedroom</option>
                        <option value="2">2 Bedrooms</option>
                        <option value="3">3 Bedrooms</option>
                        <option value="4">4 Bedrooms</option>
                        <option value="5">5+ Bedrooms</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="requestPostal">Preferred Postal Code:</label>
                    <input type="number" id="requestPostal" placeholder="e.g. 10001" min="1">
                </div>
                <div class="form-group">
                    <label for="requestType">Preferred Property Type:</label>
                    <select id="requestType">
                        <option value="1">Apartment</option>
                        <option value="2">House</option>
                        <option value="3">Studio</option>
                    </select>
                </div>
                <button class="btn" onclick="createRequest()">Create Encrypted Request</button>
            </div>

            <div class="card">
                <h3>‚ö° Match Properties</h3>
                <div class="form-group">
                    <label for="matchListingId">Your Listing ID:</label>
                    <input type="number" id="matchListingId" placeholder="Enter your listing ID" min="1">
                </div>
                <div class="form-group">
                    <label for="matchRequestId">Request ID to Match:</label>
                    <input type="number" id="matchRequestId" placeholder="Enter request ID" min="1">
                </div>
                <button class="btn" onclick="createMatch()">Create Match</button>
            </div>

            <div class="card matches-section">
                <h3>üìä Platform Statistics</h3>
                <div class="stats-grid">
                    <div class="match-card">
                        <strong>Active Listings:</strong>
                        <div id="activeListings">0</div>
                    </div>
                    <div class="match-card">
                        <strong>Active Requests:</strong>
                        <div id="activeRequests">0</div>
                    </div>
                    <div class="match-card">
                        <strong>Your Account:</strong>
                        <div id="userAccount">Not connected</div>
                    </div>
                    <div class="match-card">
                        <strong>Network:</strong>
                        <div id="networkName">Sepolia Testnet</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="user-section" id="userSection" style="display: none;">
            <h3>Your Activity</h3>
            <div class="listings-requests">
                <div class="item-list">
                    <h4>Your Listings</h4>
                    <div id="userListings">No listings yet</div>
                </div>
                <div class="item-list">
                    <h4>Your Requests</h4>
                    <div id="userRequests">No requests yet</div>
                </div>
            </div>
        </div>

        <div class="privacy-notice">
            <h4>üîí Privacy Protection</h4>
            <p>All sensitive information (prices, locations, preferences) is encrypted using FHE technology.
               Only you can see your encrypted data. Matching happens without revealing private details to unauthorized parties.</p>
        </div>

        <div class="status" id="status">
            <h4>Status</h4>
            <p>Connect your MetaMask wallet to begin using the anonymous rental matching platform.</p>
        </div>
    </div>

    <script>
        // Load ethers.js dynamically with fallback
        function loadEthers() {
            return new Promise((resolve, reject) => {
                // Try primary CDN
                const script1 = document.createElement('script');
                script1.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
                script1.onload = () => resolve();
                script1.onerror = () => {
                    // Try fallback CDN
                    const script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                    script2.onload = () => resolve();
                    script2.onerror = () => {
                        // Try third fallback
                        const script3 = document.createElement('script');
                        script3.src = 'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js';
                        script3.onload = () => resolve();
                        script3.onerror = () => reject(new Error('Failed to load ethers.js'));
                        document.head.appendChild(script3);
                    };
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script1);
            });
        }

        // Load ethers before initializing the app
        loadEthers().then(() => {
            console.log('Ethers.js loaded successfully');
        }).catch((error) => {
            console.error('Failed to load ethers.js:', error);
            document.getElementById('status').innerHTML = `
                <h4>Status</h4>
                <div class="error">
                    <p>Failed to load required libraries. Please refresh the page.</p>
                </div>
            `;
        });
    </script>
    <script>

        let contract;
        let signer;
        let provider;

        const CONTRACT_ADDRESS = "0xAe4aE413A41b03273Ba7ae927140Ca7a924cBFfE";
        const CONTRACT_ABI = [
            "function createListing(uint32 _price, uint8 _bedrooms, uint32 _postalCode, uint8 _propertyType) external",
            "function createRequest(uint32 _maxBudget, uint8 _minBedrooms, uint32 _preferredPostalCode, uint8 _preferredPropertyType) external",
            "function createMatch(uint256 _listingId, uint256 _requestId) external",
            "function confirmMatch(uint256 _matchId) external",
            "function getActiveListingsCount() external view returns (uint256)",
            "function getActiveRequestsCount() external view returns (uint256)",
            "function getUserListings(address _user) external view returns (uint256[])",
            "function getUserRequests(address _user) external view returns (uint256[])",
            "function getListingDetails(uint256 _listingId) external view returns (bool, address, uint256, bool)",
            "function getRequestDetails(uint256 _requestId) external view returns (bool, address, uint256, bool)",
            "function getMatchDetails(uint256 _matchId) external view returns (uint256, uint256, address, address, uint256, bool, bool, bool)",
            "event ListingCreated(uint256 indexed listingId, address indexed landlord)",
            "event RequestCreated(uint256 indexed requestId, address indexed tenant)",
            "event MatchCreated(uint256 indexed matchId, uint256 indexed listingId, uint256 indexed requestId)",
            "event MatchConfirmed(uint256 indexed matchId, address indexed confirmer)"
        ];

        async function connectWallet() {
            try {
                // Check if ethers is available
                if (typeof ethers === 'undefined') {
                    updateStatus("Ethers.js library is not loaded. Please refresh the page.", "error");
                    return;
                }

                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();

                    const address = await signer.getAddress();
                    const network = await provider.getNetwork();
                    const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;

                    document.getElementById('walletInfo').innerHTML = `
                        <p>‚úÖ Connected: ${shortAddress}</p>
                        <p>Network: ${network.name} (${network.chainId})</p>
                    `;

                    document.getElementById('userAccount').textContent = shortAddress;
                    document.getElementById('networkName').textContent = `${network.name} (${network.chainId})`;

                    // Initialize contract
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    updateStatus("Wallet connected successfully! You can now create listings and requests.", "success");
                    document.getElementById('userSection').style.display = 'block';

                    // Load initial data
                    loadStats();
                    loadUserData();

                    // Listen for events
                    listenToEvents();

                } else {
                    updateStatus("Please install MetaMask to use this application.", "error");
                }
            } catch (error) {
                console.error("Wallet connection error:", error);
                updateStatus("Failed to connect wallet: " + error.message, "error");
            }
        }

        async function createListing() {
            if (!contract) {
                updateStatus("Please connect your wallet first.", "error");
                return;
            }

            try {
                const price = document.getElementById('listingPrice').value;
                const bedrooms = document.getElementById('listingBedrooms').value;
                const postal = document.getElementById('listingPostal').value;
                const propertyType = document.getElementById('listingType').value;

                if (!price || !postal) {
                    updateStatus("Please fill in all required fields.", "error");
                    return;
                }

                updateStatus("Creating encrypted listing... Please confirm transaction in MetaMask.");

                const tx = await contract.createListing(
                    parseInt(price),
                    parseInt(bedrooms),
                    parseInt(postal),
                    parseInt(propertyType)
                );

                updateStatus("Transaction submitted. Waiting for confirmation...");
                const receipt = await tx.wait();

                updateStatus("Listing created successfully! Your data is encrypted on-chain.", "success");

                // Clear form
                document.getElementById('listingPrice').value = '';
                document.getElementById('listingPostal').value = '';

                // Refresh data
                loadStats();
                loadUserData();

            } catch (error) {
                console.error("Create listing error:", error);
                updateStatus("Failed to create listing: " + (error.reason || error.message), "error");
            }
        }

        async function createRequest() {
            if (!contract) {
                updateStatus("Please connect your wallet first.", "error");
                return;
            }

            try {
                const budget = document.getElementById('requestBudget').value;
                const bedrooms = document.getElementById('requestBedrooms').value;
                const postal = document.getElementById('requestPostal').value;
                const propertyType = document.getElementById('requestType').value;

                if (!budget || !postal) {
                    updateStatus("Please fill in all required fields.", "error");
                    return;
                }

                updateStatus("Creating encrypted request... Please confirm transaction in MetaMask.");

                const tx = await contract.createRequest(
                    parseInt(budget),
                    parseInt(bedrooms),
                    parseInt(postal),
                    parseInt(propertyType)
                );

                updateStatus("Transaction submitted. Waiting for confirmation...");
                const receipt = await tx.wait();

                updateStatus("Request created successfully! Your preferences are encrypted on-chain.", "success");

                // Clear form
                document.getElementById('requestBudget').value = '';
                document.getElementById('requestPostal').value = '';

                // Refresh data
                loadStats();
                loadUserData();

            } catch (error) {
                console.error("Create request error:", error);
                updateStatus("Failed to create request: " + (error.reason || error.message), "error");
            }
        }

        async function createMatch() {
            if (!contract) {
                updateStatus("Please connect your wallet first.", "error");
                return;
            }

            try {
                const listingId = document.getElementById('matchListingId').value;
                const requestId = document.getElementById('matchRequestId').value;

                if (!listingId || !requestId) {
                    updateStatus("Please enter both listing ID and request ID.", "error");
                    return;
                }

                updateStatus("Creating match... Please confirm transaction in MetaMask.");

                const tx = await contract.createMatch(parseInt(listingId), parseInt(requestId));

                updateStatus("Transaction submitted. Waiting for confirmation...");
                const receipt = await tx.wait();

                updateStatus("Match created successfully! Both parties can now confirm the match.", "success");

                // Clear form
                document.getElementById('matchListingId').value = '';
                document.getElementById('matchRequestId').value = '';

                // Refresh data
                loadStats();

            } catch (error) {
                console.error("Create match error:", error);
                updateStatus("Failed to create match: " + (error.reason || error.message), "error");
            }
        }

        async function loadStats() {
            if (!contract) return;

            try {
                const [activeListings, activeRequests] = await Promise.all([
                    contract.getActiveListingsCount(),
                    contract.getActiveRequestsCount()
                ]);

                document.getElementById('activeListings').textContent = activeListings.toString();
                document.getElementById('activeRequests').textContent = activeRequests.toString();

            } catch (error) {
                console.error("Load stats error:", error);
            }
        }

        async function loadUserData() {
            if (!contract || !signer) return;

            try {
                const address = await signer.getAddress();
                const [userListings, userRequests] = await Promise.all([
                    contract.getUserListings(address),
                    contract.getUserRequests(address)
                ]);

                // Display user listings
                const listingsDiv = document.getElementById('userListings');
                if (userListings.length === 0) {
                    listingsDiv.innerHTML = 'No listings yet';
                } else {
                    let listingsHtml = '';
                    for (let i = 0; i < userListings.length; i++) {
                        const listingId = userListings[i].toString();
                        const details = await contract.getListingDetails(listingId);
                        listingsHtml += `
                            <div class="item">
                                Listing #${listingId} - ${details[0] ? 'Active' : 'Inactive'} - ${details[3] ? 'Matched' : 'Available'}
                            </div>
                        `;
                    }
                    listingsDiv.innerHTML = listingsHtml;
                }

                // Display user requests
                const requestsDiv = document.getElementById('userRequests');
                if (userRequests.length === 0) {
                    requestsDiv.innerHTML = 'No requests yet';
                } else {
                    let requestsHtml = '';
                    for (let i = 0; i < userRequests.length; i++) {
                        const requestId = userRequests[i].toString();
                        const details = await contract.getRequestDetails(requestId);
                        requestsHtml += `
                            <div class="item">
                                Request #${requestId} - ${details[0] ? 'Active' : 'Inactive'} - ${details[3] ? 'Matched' : 'Available'}
                            </div>
                        `;
                    }
                    requestsDiv.innerHTML = requestsHtml;
                }

            } catch (error) {
                console.error("Load user data error:", error);
            }
        }

        function listenToEvents() {
            if (!contract) return;

            // Listen for new listings
            contract.on('ListingCreated', (listingId, landlord) => {
                if (landlord.toLowerCase() === signer.getAddress().toLowerCase()) {
                    updateStatus(`Your listing #${listingId} was created successfully!`, "success");
                }
                loadStats();
            });

            // Listen for new requests
            contract.on('RequestCreated', (requestId, tenant) => {
                if (tenant.toLowerCase() === signer.getAddress().toLowerCase()) {
                    updateStatus(`Your request #${requestId} was created successfully!`, "success");
                }
                loadStats();
            });

            // Listen for matches
            contract.on('MatchCreated', (matchId, listingId, requestId) => {
                updateStatus(`New match #${matchId} created between listing #${listingId} and request #${requestId}!`, "success");
                loadStats();
            });
        }

        function updateStatus(message, type = "info") {
            const statusDiv = document.getElementById('status');
            let className = '';

            if (type === "error") className = 'error';
            if (type === "success") className = 'success';

            statusDiv.innerHTML = `
                <h4>Status</h4>
                <div class="${className}">
                    <p>${message}</p>
                    <small>Time: ${new Date().toLocaleTimeString()}</small>
                </div>
            `;
        }

        // Handle account/network changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length > 0) {
                    location.reload();
                } else {
                    document.getElementById('walletInfo').innerHTML = `
                        <button class="btn connect-btn" onclick="connectWallet()">Connect MetaMask Wallet</button>
                        <p>Connect your wallet to start using the platform</p>
                    `;
                    updateStatus("Wallet disconnected.");
                    document.getElementById('userSection').style.display = 'none';
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }

        // Auto-connect if already connected (wait for ethers to load)
        function initializeApp() {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                    if (accounts.length > 0) {
                        connectWallet();
                    }
                });
            }
        }

        // Initialize app after ethers is loaded
        window.addEventListener('load', () => {
            // Wait a bit for ethers to load, then initialize
            setTimeout(() => {
                if (typeof ethers !== 'undefined') {
                    initializeApp();
                } else {
                    // Retry after another delay
                    setTimeout(() => {
                        if (typeof ethers !== 'undefined') {
                            initializeApp();
                        }
                    }, 2000);
                }
            }, 1000);
        });
    </script>
</body>
</html>